<!DOCTYPE html>
<meta charset="utf-8">
<head>
	<title> Responsive Chart </title>
	<style>
		body {
		  font: 14px sans-serif;
		  
		}

		.axis path,
		.axis line {
		  fill: none;
		  stroke: #000;
		  shape-rendering: crispEdges;
		}

		.x.axis path {
		  display: black;
		}

		.line {
		  fill: none;
		  stroke: steelblue;
		  stroke-width: 1.5px;
		}
	</style>
	
	<script src="http://d3js.org/d3.v3.js"></script>
	
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
	
	<script>
		var margin 		= {top: 120, right: 120, bottom: 80, left: 100};
		var page_width 	= document.documentElement.clientWidth;
		var page_height = document.documentElement.clientHeight;
		var width 		= page_width - margin.left - margin.right;
		var height 		= page_height - margin.top - margin.bottom;
		var svg;
		var no_of_ticks_x = width  / 100;
		var no_of_ticks_y = height / 50;
		var rect_data = [];

		function display_money (p_id) {
			var num = Number (p_id.match(/\d+/g));
			var rect_id = "rect" + num;
			var rect_pos_x;
			var rect_pos_y;
			var rect_status;
			var index;
			for ( index = 0; index < rect_data.length; index++) {
				if (p_id == rect_data[index].id) {
					rect_pos_x = rect_data[index].x - 50;
					rect_pos_y = rect_data[index].y - 30;
					rect_status = rect_data[index].s;
					break;
				}
			}
			if (rect_status == 0) {
				d3.select("#"+rect_id).remove();
				rect_data[index].s = 1;
			} else {
				rect_data[index].s = 0;
				var myrect = svg.append("rect")
					.attr("class","ro")
					.attr("height", 30)
					.attr("width",50)
					.attr("fill", "blue")
					.attr("x", rect_pos_x)
					.attr("y", rect_pos_y)
					.attr("id",rect_id);
			}
		}
		
		function load_chart () {
			var parseDate;
			var x, y;
			var color;
			var xAxis, yAxis;
			var line;
			var json_data;
			var json_data_c;
			var json_transactions;
			var ndays;
			var max_money;
			var transactions, transaction;
			var color_rect;
			var day;
			var money_on_date;
			var rect_data_i = 0;
			
			$(document).ready(function(){
				parseDate = d3.time.format("%Y%m%d")
							.parse;

				x = d3.time.scale()
					.range([0, width]);

				y = d3.scale.linear()
					.range([height,0]);

				color = d3.scale.category10();
				
				xAxis = d3.svg.axis()
						.scale(x)
						.orient("bottom")
						.ticks(no_of_ticks_x);

				yAxis = d3.svg.axis()
						.scale(y)
						.orient("left")
						.ticks(no_of_ticks_y);

				line = 	d3.svg.line()
						.interpolate("basis")
						.x(function(d) { return x(d.date); })
						.y(function(d) { return y(d.money); });
					
				svg = 	d3.select("body").append("svg")
						.attr("width", width + margin.left + margin.right)
						.attr("height", height + margin.top + margin.bottom)
						.append("g")
						.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
				
				// Load and parse data
				$.ajax({
                    url: "data.txt",
                    dataType: "text",
                    success: function(data) {
                        json_data = $.parseJSON(data);
						json_data_c = $.parseJSON(data);
						max_money = 0;
						ndays = 0;
						for ( var index = 0; index < json_data.data.length; index++) {
							json_data.data[index].date = parseDate(json_data.data[index].date);
							if (json_data.data[index].money > max_money)
								max_money = json_data.data[index].money;
							ndays++;
						}
						color.domain(["date","money"]);
						transactions = color.domain().map(function(name) {
							return {
								name: name,
								values: json_data.data.map(function(d) {
											return {date: d.date, money: +d[name]};
										})
							};
						});
						
						x.domain(d3.extent(json_data.data, function(d) { return d.date; }));
						y.domain(d3.extent(json_data.data, function(d) { return d.money; }));
						
						svg.append("g")
							.attr("class", "x axis")
							.attr("transform", "translate(0," + height + ")")
							.call(xAxis);

						svg.append("g")
							.attr("class", "y axis")
							.call(yAxis)
							.append("text")
							.attr("transform", "rotate(-90)")
							.attr("y", 6)
							.attr("dy", ".71em")
							.style("text-anchor", "end")
							.text("Investment");

						transaction = 	svg.selectAll(".transactions")
										.data(transactions)
										.enter().append("g")
										.attr("class", "transactions");
							
						transaction.append("path")
							.attr("class", "line")
							.attr("d", function(d){return line(d.values);})
							.style("stroke",function(d){return color(d.name);});
							
						transaction.append("text")
							.datum(function(d) { return {name: d.name, value: d.values[d.values.length - 1]}; })
							.attr("transform", function(d) { return "translate(" + x(d.value.date) + "," + y(d.value.money) + ")"; })
							.attr("x", ".3em")
							.attr("dy", ".35em")
							.text(function(d) { return d.name; });
					}		
                });
				
				// Load and parse transactions
				$.ajax({
                    url: "transactions.txt",
                    dataType: "text",
                    success: function(data) {
                        json_transactions = $.parseJSON(data);
						for (var i = 0; i < json_transactions.transactions.length; i++) {
							day = 0;
							for (var j = 0; j < json_data_c.data.length; j++) {
								day++;
								if (json_data_c.data[j].date == json_transactions.transactions[i].date) {
									money_on_date = json_data_c.data[j].money;
									if (json_transactions.transactions[i].type == "w") color_rect = "red";
									else color_rect = "green";
									break;
								}
							}
							
							rect_pos_x = day / ndays * width;
							rect_pos_y = height - money_on_date / max_money * height;
							rect_id = "r" + rect_data_i;
							rect_data[rect_data_i++] = { id:rect_id, x:rect_pos_x, y:rect_pos_y, s:1 };
	
							svg.append("rect")
								.attr("height", 20)
								.attr("width",20)
								.attr("fill", color_rect)
								.attr("id",rect_id)
								.attr("onclick","display_money(this.id)")
								.attr("x", rect_pos_x)
								.attr("y", rect_pos_y);
						}		
                    }
                });
			});
		}
		
		// resize
		d3.select(window).on('resize', resize);
		
		function resize() {
			// update width and height
			width 	= document.documentElement.clientWidth - margin.left - margin.right;
			height 	= document.documentElement.clientHeight - margin.top - margin.bottom;
			no_of_ticks_x = width / 100;
			no_of_ticks_y = height / 50;
			
			// Erase old chart
			d3.select("svg").remove();

			// Redraw chart			
			load_chart();
		}
	</script>

<body onload = "load_chart()">

</body>